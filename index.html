<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Task Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #fff);
      --text: var(--tg-theme-text-color, #000);
      --hint: var(--tg-theme-hint-color, #888);
      --btn: var(--tg-theme-button-color, #2481cc);
      --btn-text: var(--tg-theme-button-text-color, #fff);
      --secondary: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --header-bg: var(--tg-theme-header-bg-color, #fff);
      --radius: 12px;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding-bottom: 90px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
      -webkit-font-smoothing: antialiased;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
    ::-webkit-scrollbar { width: 0; background: transparent; }

    h2 { margin: 0 0 10px; font-size: 20px; font-weight: 700; }
    .container { padding: 16px; max-width: 600px; margin: 0 auto; }

    /* –ö–ê–†–¢–û–ß–ö–ò –ó–ê–î–ê–ß */
    .card {
      background: var(--secondary);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: opacity 0.2s;
    }
    .card.done { opacity: 0.5; }
    .card.done .txt { text-decoration: line-through; }
    
    .check-circle {
      width: 24px; height: 24px;
      border: 2px solid var(--hint);
      border-radius: 50%;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    .check-circle.checked {
      background: var(--btn);
      border-color: var(--btn);
    }
    .check-circle.checked::after {
      content: '‚úì'; color: #fff; font-size: 14px; font-weight: bold;
    }

    .txt { flex: 1; font-size: 16px; word-break: break-word; }
    .del-btn { color: #ff3b30; padding: 8px; cursor: pointer; opacity: 0.7; }

    /* –ü–û–õ–ï –í–í–û–î–ê */
    .input-row {
      display: flex; gap: 10px; margin-bottom: 20px;
      position: sticky; top: 0; z-index: 10;
      background: var(--bg);
      padding: 10px 0;
    }
    input {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius);
      border: none;
      background: var(--secondary);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    input:focus { box-shadow: 0 0 0 2px var(--btn); }
    
    .btn-main {
      background: var(--btn);
      color: var(--btn-text);
      border: none;
      padding: 0 20px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
    }

    /* –í–ö–õ–ê–î–ö–ò (–ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ) */
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--header-bg);
      border-top: 1px solid var(--secondary);
      display: flex; justify-content: space-around;
      padding: 10px 0;
      padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* –î–ª—è iPhone */
      z-index: 100;
    }
    .tab {
      flex: 1; text-align: center;
      padding: 8px;
      color: var(--hint);
      font-size: 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .tab span { font-size: 20px; display: block; }
    .tab.active { color: var(--btn); font-weight: 600; }

    /* –≠–ö–†–ê–ù–´ */
    .view { display: none; animation: fadeIn 0.2s; }
    .view.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø—Ä–∏–≤—ã—á–µ–∫ */
    .stat-row { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .stat-box { background: var(--secondary); padding: 15px; border-radius: var(--radius); flex: 1; margin: 0 5px; text-align: center; }
    .stat-val { font-size: 24px; font-weight: bold; color: var(--btn); }
  </style>
</head>
<body>

  <div id="viewTasks" class="view active container">
    <h2>üìÖ –ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
    
    <div class="input-row">
      <input type="text" id="taskInput" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞...">
      <button class="btn-main" onclick="addTask()">‚ûï</button>
    </div>

    <div id="taskList">
      <div style="text-align:center; color:var(--hint); margin-top:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <div id="viewHabits" class="view container">
    <h2>üî• –ü—Ä–∏–≤—ã—á–∫–∏</h2>
    <div class="stat-row">
      <div class="stat-box">
        <div class="stat-val" id="habitsCount">0</div>
        <small>–í—Å–µ–≥–æ</small>
      </div>
      <div class="stat-box">
        <div class="stat-val">0</div>
        <small>–°—Ç—Ä–∏–∫</small>
      </div>
    </div>
    
    <div class="input-row">
      <input type="text" id="habitInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏...">
      <button class="btn-main" onclick="addHabit()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div id="habitList"></div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('viewTasks', this)">
      <span>üìù</span>–ó–∞–¥–∞—á–∏
    </div>
    <div class="tab" onclick="switchTab('viewHabits', this)">
      <span>üî•</span>–ü—Ä–∏–≤—ã—á–∫–∏
    </div>
    <div class="tab" onclick="alert('–°–∫–æ—Ä–æ!')">
      <span>‚öôÔ∏è</span>–ú–µ–Ω—é
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // !!! –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É –∏–∑ Cloudflare !!!
    const API_URL = "https://hosts-dominant-displays-pushed.trycloudflare.com"; 
    
    const userId = tg.initDataUnsafe?.user?.id || 12345; // –î–ª—è —Ç–µ—Å—Ç–æ–≤

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    function switchTab(viewId, tabEl) {
      document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      
      document.getElementById(viewId).classList.add('active');
      tabEl.classList.add('active');
    }

    // --- –ó–ê–î–ê–ß–ò ---
    async function loadTasks() {
      try {
        let res = await fetch(`${API_URL}/api/get_tasks?user_id=${userId}`);
        let tasks = await res.json();
        let list = document.getElementById('taskList');
        list.innerHTML = "";
        
        if(tasks.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:var(--hint); margin-top:20px;">–ó–∞–¥–∞—á –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π! üèñ</div>`;
            return;
        }

        tasks.forEach(t => renderTask(t));
      } catch (e) {
        document.getElementById('taskList').innerHTML = `<div style="color:red; text-align:center;">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ üòî</div>`;
      }
    }

    function renderTask(task) {
      let list = document.getElementById('taskList');
      let div = document.createElement('div');
      div.className = `card ${task.done ? 'done' : ''}`;
      div.innerHTML = `
        <div class="check-circle ${task.done ? 'checked' : ''}" onclick="toggleTask(${task.id}, this)"></div>
        <span class="txt">${task.text}</span>
        <div class="del-btn" onclick="deleteTask(${task.id}, this.parentElement)">üóë</div>
      `;
      list.prepend(div);
    }

    async function addTask() {
      let input = document.getElementById('taskInput');
      let text = input.value.trim();
      if (!text) return;

      input.value = ""; // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ —Å—Ä–∞–∑—É
      
      // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π UI (–¥–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É, –Ω–µ –∂–¥–µ–º —Å–µ—Ä–≤–µ—Ä)
      renderTask({ id: Date.now(), text: text, done: false }); 

      await fetch(`${API_URL}/api/add_task`, {
        method: 'POST', body: JSON.stringify({ user_id: userId, text: text })
      });
      // –ü–æ-—Ö–æ—Ä–æ—à–µ–º—É —Ç—É—Ç –Ω–∞–¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π ID, –Ω–æ –¥–ª—è MVP —Å–æ–π–¥–µ—Ç
    }

    async function deleteTask(id, el) {
      if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 200); // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        await fetch(`${API_URL}/api/delete_task`, {
          method: 'POST', body: JSON.stringify({ id: id })
        });
      }
    }
    
    function toggleTask(id, btn) {
        let card = btn.parentElement;
        let isDone = !btn.classList.contains('checked');
        
        btn.classList.toggle('checked');
        card.classList.toggle('done');
        
        // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API –≤—ã–∑–æ–≤ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞, –µ—Å–ª–∏ –≤ –±–∞–∑–µ –µ—Å—Ç—å update
    }

    // --- –ü–†–ò–í–´–ß–ö–ò (–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è UI) ---
    async function addHabit() {
        let input = document.getElementById('habitInput');
        let text = input.value;
        if(!text) return;
        
        let list = document.getElementById('habitList');
        list.innerHTML += `<div class="card"><span class="txt">üî• ${text}</span> <small>0 –¥–Ω–µ–π</small></div>`;
        input.value = "";
    }

    // –ó–∞–ø—É—Å–∫
    loadTasks();
  </script>
</body>
</html>